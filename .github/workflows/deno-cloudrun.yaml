# Deno Cloud Run Deploy - Reusable CI/CD Workflow
#
# This workflow provides opinionated CI/CD for Deno apps deploying to GCP Cloud Run.
# CI: lint → check → test, CD: deno compile → buildah → GHCR → Cloud Run
#
# Usage in app repo:
#   jobs:
#     deploy:
#       uses: dmikalova/github-meta/.github/workflows/deno-cloudrun.yaml@main
#       secrets: inherit

name: Deno Cloud Run Deploy

on:
  workflow_call:

# Hardcoded GCP configuration (convention over configuration)
env:
  GCP_PROJECT: mklv-infrastructure
  GCP_REGION: us-west1
  WIF_PROVIDER: projects/443065563587/locations/global/workloadIdentityPools/github/providers/github-oidc
  WIF_SERVICE_ACCOUNT: github-actions-deploy@mklv-infrastructure.iam.gserviceaccount.com

jobs:
  pipeline:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for semantic-release

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      # CI: lint, check, test
      - name: Lint
        env:
          DENO_AUTH_TOKENS: ${{ secrets.GITHUB_TOKEN }}@npm.pkg.github.com
        run: deno lint

      - name: Type Check
        env:
          DENO_AUTH_TOKENS: ${{ secrets.GITHUB_TOKEN }}@npm.pkg.github.com
        run: deno task check

      - name: Test
        env:
          DENO_AUTH_TOKENS: ${{ secrets.GITHUB_TOKEN }}@npm.pkg.github.com
        run: deno task test

      # Release: determine version using semantic-release
      - name: Setup Node
        if: github.ref == 'refs/heads/main'
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Cache npm packages
        if: github.ref == 'refs/heads/main'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-semantic-release-${{ runner.os }}

      - name: Create semantic-release config
        if: github.ref == 'refs/heads/main'
        run: |
          cat > release.config.mjs << 'EOF'
          export default {
            branches: ["main"],
            plugins: [
              "@semantic-release/commit-analyzer",
              "@semantic-release/release-notes-generator",
              ["@semantic-release/github", { failComment: false }],
            ],
          };
          EOF

      - name: Semantic Release
        id: release
        if: github.ref == 'refs/heads/main'
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Get version: use new release version or fall back to latest tag
      - name: Get Version
        id: version
        if: github.ref == 'refs/heads/main'
        run: |
          if [ "${{ steps.release.outputs.new_release_published }}" == "true" ]; then
            echo "version=${{ steps.release.outputs.new_release_version }}" >> $GITHUB_OUTPUT
          else
            # Get latest tag version (strip 'v' prefix)
            latest=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "version=${latest#v}" >> $GITHUB_OUTPUT
          fi

      # Get app name from config
      - name: Get App Name
        id: app
        if: github.ref == 'refs/heads/main'
        env:
          DENO_AUTH_TOKENS: ${{ secrets.GITHUB_TOKEN }}@npm.pkg.github.com
        run: |
          name=$(deno eval "import c from './mklv.config.mts'; console.log(c.name)")
          echo "name=$name" >> $GITHUB_OUTPUT

      # Build: deno compile to standalone binary
      - name: Compile Binary
        if: github.ref == 'refs/heads/main'
        env:
          DENO_AUTH_TOKENS: ${{ secrets.GITHUB_TOKEN }}@npm.pkg.github.com
        run: deno compile --output app src/main.ts

      # Build container with Buildah (no Dockerfile needed)
      - name: Build Container
        if: github.ref == 'refs/heads/main'
        run: |
          ctr=$(buildah from gcr.io/distroless/base-debian12)
          buildah copy $ctr ./app /app
          buildah config --entrypoint '["/app"]' $ctr
          buildah config --port 8000 $ctr
          buildah commit $ctr ${{ steps.app.outputs.name }}:${{ steps.version.outputs.version }}

      # Push to GHCR
      - name: Push to GHCR
        if: github.ref == 'refs/heads/main'
        run: |
          image=ghcr.io/dmikalova/${{ steps.app.outputs.name }}:${{ steps.version.outputs.version }}
          buildah tag ${{ steps.app.outputs.name }}:${{ steps.version.outputs.version }} $image
          buildah login -u dmikalova -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
          buildah push $image
          echo "Published: $image"

      # Deploy to Cloud Run
      - name: Authenticate to GCP
        if: github.ref == 'refs/heads/main'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Deploy to Cloud Run
        if: github.ref == 'refs/heads/main'
        run: |
          image=ghcr.io/dmikalova/${{ steps.app.outputs.name }}:${{ steps.version.outputs.version }}
          gcloud run deploy ${{ steps.app.outputs.name }} \
            --image $image \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT }} \
            --quiet
