# Deno Cloud Run Deploy - Reusable CI/CD Workflow
#
# This workflow provides opinionated CI/CD for Deno apps deploying to GCP Cloud Run.
# It runs Dagger pipeline for lint → test → build → migrate → deploy.
#
# Usage in app repo:
#   jobs:
#     deploy:
#       uses: dmikalova/github-meta/.github/workflows/deno-cloudrun.yaml@main
#       secrets: inherit

name: Deno Cloud Run Deploy

on:
  workflow_call:

# Hardcoded GCP configuration (convention over configuration)
env:
  DAGGER_NO_NAG: true
  DAGGER_PROGRESS: plain
  GCP_PROJECT: mklv-infrastructure
  GCP_REGION: us-west1
  WIF_PROVIDER: projects/mklv-infrastructure/locations/global/workloadIdentityPools/github/providers/github-oidc
  WIF_SERVICE_ACCOUNT: github-actions-deploy@mklv-infrastructure.iam.gserviceaccount.com

jobs:
  pipeline:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for semantic-release

      # CI: lint, check, test
      - name: Run Dagger CI
        uses: dagger/dagger-for-github@v6
        with:
          version: "0.19.11"
          verb: call
          module: github.com/dmikalova/github-meta/dagger/deno
          args: ci --source=.

      # Release: determine version using semantic-release
      - name: Setup Node
        if: github.ref == 'refs/heads/main'
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Semantic Release
        id: release
        if: github.ref == 'refs/heads/main'
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Deploy: only when a release was created
      - name: Authenticate to GCP
        if: steps.release.outputs.new_release_published == 'true'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Run Dagger CD
        if: steps.release.outputs.new_release_published == 'true'
        uses: dagger/dagger-for-github@v6
        with:
          version: "0.19.11"
          verb: call
          module: github.com/dmikalova/github-meta/dagger/deno
          args: >-
            deploy-only
            --source=.
            --version=${{ steps.release.outputs.new_release_version }}
            --github-token=env:GITHUB_TOKEN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
