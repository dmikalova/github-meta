# Deno Cloud Run Deploy - Reusable CI/CD Workflow
#
# This workflow provides opinionated CI/CD for Deno apps deploying to GCP Cloud Run.
# CI: lint → check → test, CD: deno compile → buildah → GHCR → Cloud Run
#
# Usage in app repo:
#   jobs:
#     deploy:
#       uses: dmikalova/github-meta/.github/workflows/deno-cloudrun.yaml@main
#       secrets: inherit

name: Deno Cloud Run Deploy

on:
  workflow_call:

# Hardcoded GCP configuration (convention over configuration)
env:
  GCP_PROJECT: mklv-infrastructure
  GCP_REGION: us-west1
  WIF_PROVIDER: projects/443065563587/locations/global/workloadIdentityPools/github/providers/github-oidc
  WIF_SERVICE_ACCOUNT: github-actions-deploy@mklv-infrastructure.iam.gserviceaccount.com

jobs:
  pipeline:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for semantic-release

      - name: Configure NPM
        run: |
          cp .npmrc $HOME/.npmrc

      - name: Cache Git Objects
        uses: actions/cache@v4
        with:
          path: .git/objects
          key: git-${{ github.repository }}-${{ github.ref_name }}
          restore-keys: |
            git-${{ github.repository }}-

      - name: Cache Deno
        uses: actions/cache@v4
        with:
          path: ~/.cache/deno
          key: deno-${{ runner.os }}-${{ hashFiles('deno.lock') }}
          restore-keys: |
            deno-${{ runner.os }}-

      - name: Deno Setup
        uses: denoland/setup-deno@v2
        with:
          deno-version-file: .deno-version

      - name: Deno Install
        env:
          NPM_TOKEN: ${{ secrets.PKG_READ_TOKEN }}
        run: deno install

      - name: Deno Lint
        run: deno lint

      - name: Deno Type Check
        run: deno task check

      - name: Deno Test
        run: deno task test

      - name: Cache NPM
        if: github.ref == 'refs/heads/main'
        uses: actions/cache@v4
        with:
          path: $HOME/.npm
          key: npm-semantic-release-${{ runner.os }}

      - name: Semantic Release
        id: release
        if: github.ref == 'refs/heads/main'
        uses: cycjimmy/semantic-release-action@v4
        with:
          extends: "@dmikalova/semantic-release-config"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.PKG_READ_TOKEN }}

      - name: Release Info
        id: info
        if: github.ref == 'refs/heads/main'
        run: |
          echo "name=$(deno run mklv.config.mts | jq -r .name)" >> $GITHUB_OUTPUT
          if [ "${{ steps.release.outputs.new_release_published }}" == "true" ]; then
            echo "version=${{ steps.release.outputs.new_release_version }}" >> $GITHUB_OUTPUT
          else
            latest=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "version=${latest#v}" >> $GITHUB_OUTPUT
          fi

      - name: Cache Buildah
        if: github.ref == 'refs/heads/main'
        uses: actions/cache@v4
        with:
          path: ~/.local/share/containers
          key: buildah-${{ runner.os }}-deno-distroless

      - name: Container Build
        if: github.ref == 'refs/heads/main'
        env:
          NPM_TOKEN: ${{ secrets.PKG_READ_TOKEN }}
        run: |
          DENO_VERSION=$(cat .deno-version)

          # Build stage
          ctr=$(buildah from docker.io/denoland/deno:${DENO_VERSION})
          buildah config --workingdir /app $ctr
          buildah copy $ctr . /app
          echo "here"
          pwd
          ls -la
          ls -la ../
          ls -la $HOME
          buildah copy $ctr $HOME/.npmrc /root/.npmrc
          buildah run --env NPM_TOKEN=$NPM_TOKEN $ctr -- deno cache src/main.ts

          # Production stage
          prod=$(buildah from docker.io/denoland/deno:distroless-${DENO_VERSION})
          buildah copy --from $ctr $prod /app /app
          buildah copy --from $ctr $prod /deno-dir /deno-dir
          buildah config --env DENO_DIR=/deno-dir $prod
          buildah config --workingdir /app $prod
          buildah config --cmd 'run -A --cached-only src/main.ts' $prod
          buildah commit $prod ${{ steps.info.outputs.name }}:${{ steps.info.outputs.version }}

      - name: GHCR Push
        if: github.ref == 'refs/heads/main'
        run: |
          image=ghcr.io/dmikalova/${{ steps.info.outputs.name }}:${{ steps.info.outputs.version }}
          buildah tag ${{ steps.info.outputs.name }}:${{ steps.info.outputs.version }} $image
          buildah login -u dmikalova -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
          buildah push $image

      - name: GCP Authenticate
        if: github.ref == 'refs/heads/main'
        uses: google-github-actions/auth@v2
        with:
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ env.WIF_PROVIDER }}

      - name: Cloud Run Deploy
        if: github.ref == 'refs/heads/main'
        run: |
          image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/ghcr/dmikalova/${{ steps.info.outputs.name }}:${{ steps.info.outputs.version }}
          gcloud run deploy ${{ steps.info.outputs.name }} \
            --image $image \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT }} \
            --quiet
