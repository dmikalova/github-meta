# Deno Cloud Run Deploy - Reusable CI/CD Workflow
#
# This workflow provides opinionated CI/CD for Deno apps deploying to GCP Cloud Run.
# It runs Dagger pipeline for lint → test → build → migrate → deploy.
#
# Usage in app repo:
#   jobs:
#     deploy:
#       uses: dmikalova/github-meta/.github/workflows/deno-cloudrun.yaml@main
#       secrets: inherit

name: Deno Cloud Run Deploy

on:
  workflow_call:

# Hardcoded GCP configuration (convention over configuration)
env:
  DAGGER_NO_NAG: true
  GCP_PROJECT: mklv-infrastructure
  GCP_REGION: us-west1
  WIF_PROVIDER: projects/443065563587/locations/global/workloadIdentityPools/github/providers/github-oidc
  WIF_SERVICE_ACCOUNT: github-actions-deploy@mklv-infrastructure.iam.gserviceaccount.com

jobs:
  pipeline:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for semantic-release

      # Cache Dagger engine and modules
      - name: Cache Dagger
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/dagger
            ~/.local/share/dagger
          key: dagger-${{ runner.os }}-0.19.11

      # CI: lint, check, test
      - name: Run Dagger CI
        uses: dagger/dagger-for-github@v6
        with:
          version: "0.19.11"
          verb: call
          module: github.com/dmikalova/github-meta/dagger/deno
          args: ci --source=. --github-token=env:GITHUB_TOKEN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Release: determine version using semantic-release
      - name: Setup Node
        if: github.ref == 'refs/heads/main'
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Cache npm packages
        if: github.ref == 'refs/heads/main'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-semantic-release-${{ runner.os }}

      - name: Create semantic-release config
        if: github.ref == 'refs/heads/main'
        run: |
          cat > release.config.mjs << 'EOF'
          export default {
            branches: ["main"],
            plugins: [
              "@semantic-release/commit-analyzer",
              "@semantic-release/release-notes-generator",
              ["@semantic-release/github", { failComment: false }],
            ],
          };
          EOF

      - name: Semantic Release
        id: release
        if: github.ref == 'refs/heads/main'
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Get version: use new release version or fall back to latest tag
      - name: Get Version
        id: version
        if: github.ref == 'refs/heads/main'
        run: |
          if [ "${{ steps.release.outputs.new_release_published }}" == "true" ]; then
            echo "version=${{ steps.release.outputs.new_release_version }}" >> $GITHUB_OUTPUT
          else
            # Get latest tag version (strip 'v' prefix)
            latest=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "version=${latest#v}" >> $GITHUB_OUTPUT
          fi

      # Deploy: always on main (use new release or latest tag)
      - name: Authenticate to GCP
        if: github.ref == 'refs/heads/main'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Run Dagger CD
        if: github.ref == 'refs/heads/main'
        uses: dagger/dagger-for-github@v6
        with:
          version: "0.19.11"
          verb: call
          module: github.com/dmikalova/github-meta/dagger/deno
          args: >-
            deploy-only
            --source=.
            --version=${{ steps.version.outputs.version }}
            --github-token=env:GITHUB_TOKEN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
